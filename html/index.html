<html>
  <head>
    <title>Stellar Expanse</title>

    <script src="/yote/js/jquery-latest.js"></script>
    <script src="/yote/js/jquery.dumper.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/json2.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>
    <script src="/yote/js/yote.system.util.js"></script>
    <link href="/css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/bootstrap-responsive.css" rel="stylesheet" type="text/css" media="all" />
    <link rel="stylesheet" href="/yote/css/jquery.mobile.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/yote/css/ui-lightness/jquery-ui-1.8.23.custom.css" type="text/css" media="all" />
    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />

    <script>
    $().ready(function(){
        $.yote.debug = true;
	$.yote.init();

        var se_app = $.yote.fetch_app( 'StellarExpanse::App' );

	function msg( m, cls ) {
	    $( '#msg_div' ).empty().append( '<div class="' + cls + '">' + m + '</div>' );
	}

        function to_game_login( login, acct, message ) {
            var active_games  = acct.get_active_games();
            var pending_games = acct.get_pending_games();
            var avail_games   = se_app.available_games();
	    $( '#outer_div' ).empty().append( '<div id="msg_div">' + message + '</div><div id="main_div"><dl id="main_dl"></dl></div>' );

	    if( active_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Number of Players', 'Created By', 'On Turn', 'Play' ] );
		for( var i=0 ; i < active_games.length() ; i ++ ) {
		    var game = active_games.get( i );
		    tab.add_row( [ game.get_name(), game.get_number_players(), game.get_created_by().get_handle(), game.get_turn_number(), '<button type="button" id="play_' + game.id + '" class="btn btn-link">Play</button>' ] );
		}
		$( '#main_dl' ).append( "<dt>Active Games</dt><tt>" + tab.get_html() + "</tt>" );
		for( var i=0 ; i < active_games.length() ; i ++ ) {
		    var g = active_games.get( i );
		    $( '#play_' + g.id ).click( (function( game, acct ) { return function() {
			play_game( game, acct );
		    } } )( g, acct ) );
		}
	    } //active games

	    if( pending_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Joined Players', 'Created By', 'Leave' ] );
		for( var i=0 ; i < pending_games.length() ; i ++ ) {
		    var game = pending_games.get( i );
		    tab.add_row( [ game.get_name(), game.active_player_count() + " of " + game.get_number_players(), game.get_created_by().get_handle(), '<button type="button" id="leave_' + game.id + '" class="btn btn-link">Leave Game</button>' ] );
		}
		$( '#main_dl' ).append( "<dt>Games waiting to start</dt><tt>" + tab.get_html() + "</tt>" );
		for( var i=0 ; i < pending_games.length() ; i ++ ) {
		    var g = pending_games.get( i );
		    $( '#leave_' + g.id ).click( (function( game, login, acct ) { return function() {
			game.remove_player('',function(m){ to_game_login( login, acct, m ) },function(e){ msg( e ) });
		    } } )( g, login, acct ) );
		}
	    } //pending games

	    if( avail_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Joined Players', 'Starting Tech', 'Starting Resources', 'Created By', 'Join' ] );
		for( var i=0 ; i < avail_games.length() ; i ++ ) {
		    var game = avail_games.get( i );
		    tab.add_row( [ game.get_name(),
				   game.active_player_count() + " of " + game.get_number_players(),
				   game.get_starting_tech_level(),
				   game.get_starting_resources(),
				   game.get_created_by().get_handle(),
				   '<button type="button" id="join_' + game.id + '" class="btn btn-link">Join Game</button>'
				 ] );
		}
		$( '#main_dl' ).append( "<dt>Available Games</dt><tt>" + tab.get_html() + "</tt>" );
		for( var i=0 ; i < avail_games.length() ; i ++ ) {
		    var g = avail_games.get( i );
		    $( '#join_' + g.id ).click( (function( game, login, acct ) { return function() {
			game.add_player( '', function(m) { to_game_login( login, acct, m ) },function(e){msg( e ) } );
		    } } )( g, login, acct ) );
		}
	    } //available games

	    $( '#main_div' ).append( '<button id="newgame" type="button">New Game</button>' );
	    $( '#newgame' ).click(function() {
		$( '#main_div' ).empty().append( "<h2>Create New Game</h2>" );
		var tab = $.yote.util.make_table();
		var flavors = se_app.get_flavors();
		tab.add_param_row( [ 'Name', '<input type="text" id="game_name_fld">' ] );
		if( flavors.length() > 1 ) {
		    tab.add_param_row( [ 'Flavor', '<select id="flavor_sel"></select>' ] );
		} else {
		    var fl = flavors.get(0);
		    tab.add_param_row( [ 'Flavor', '<span>' + fl.get_name() +
					 '</span><input type="hidden" id="flavor_sel" value="0">' ] );

		}
		tab.add_param_row( [ 'Number of Players', '<select id="player_sel"></select>' ] );
		tab.add_param_row( [ 'Starting Tech Level', '<select id="tech_sel"></select>' ] );
		tab.add_param_row( [ 'Starting Resources', '<input type="text" id="resource_fld">' ] );
		$( '#main_div' ).append( tab.get_html() + '<BR><button type="button" id="create_game" class="btn disabled btn-link">Create</button>' );
		if( flavors.length() > 1 ) {
		    for( var i=0; i<flavors.length(); ++i ) {
			var flav = flavors.get(i);
			$('#flavor_sel').append( '<option value="' + i + '">' + flav.get_name() + '</option>' );
		    }
		}
		for( var i=1; i < 5; i++ ) {
		    $('#tech_sel').append( '<option value="' + i + '">' + i + '</option>' );
		}
		for( var i=1; i < 9; i++ ) {
		    $('#player_sel').append( '<option value="' + i + '">' + i + '</option>' );
		}
		$( '#game_name_fld,#resource_fld' ).keyup(function() {
		    if( $( '#game_name_fld' ).val() && $( '#resource_fld' ).val() > 0 ) {
			$( '#create_game' ).removeClass( 'disabled' );
		    } else {
			$( '#create_game' ).addClass( 'disabled' );
		    }
		} );
		$( '#create_game' ).click( function() {
		    se_app.create_game(
			{
                            name:$('#game_name_fld').val(),
                            number_players:$('#player_sel').val(),
			    starting_resources:$('#resource_fld').val(),
			    starting_tech_level:$('#tech_sel').val(),
			    flavor:flavors.get($('#flavor_sel').val())
			},
			function( msg ) {
			    to_game_login( login, acct, msg );
			},
			function( err ) {
			    msg( err );
			}
		    );
		} );
	    });


	} //to_game_login

	$.yote.util.make_login_bar( { brand_html         : '<a class="brand"><IMG src="se.png"> <huge>Stellar Expanse</huge></a>',
				      app                : se_app,
				      container_id       : '#nav-container',
				      logged_in_function : function( login, act ) { to_game_login( login, act, "Welcome, " + login.get_handle()) } ,
				      not_logged_in_function : function(){$('#games').hide();},
				      modal_div          : '#modal_div'
				    } );
    });
    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
      .bordered { border: 1px solid black;padding:5px; margin: 5px;}
    </style>
  </head>
  <body>
    <div STYLE="background-color:#181818;vertical-align:middle">
	<div id="nav-container" class="container" style="width: auto"></div>
    </div>

    <HEADER class="jumbotron subhead" style="height:70px">
      &nbsp;
      <div style="position:fixed;top:350px;left:350px;" id="modal_div"></div>
    </HEADER>

    <DIV id="outer_div" style="margin:10px">
    </DIV>
    <script src="/js/bootstrap.js"></script>
  </body>
</html>
