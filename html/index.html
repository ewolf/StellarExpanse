<html>
  <head>
    <title>Stellar Expanse</title>
    <script src="/js/jquery-latest.js"></script>
    <script src="/js/jquery.dumper.js"></script>
    <script src="/js/jquery.base64.min.js"></script>
    <script src="/js/json2.js"></script>
    <script src="/js/yote/yote.js"></script>
    <script src="/js/yote/yote.util.js"></script>
    <script>
    $().ready(function(){

        var se_app = $.yote.get_app( 'StellarExpanse::App' );

        function message( msg ) {
            $('#msg').empty();
            if( typeof msg !== 'undefined' ) {
                $('#msg').append( msg + '<BR>' );
            }
        } //message

        function show_game(game, already_member) {
            $('#games').hide();
            var eg = $('#examine_game');
            eg.empty();
            eg.
                append($("<p/>").append(game.get('name'))).
                append($("<p/>").append(game.get('number_players'))).
                append($("<p/>").append(game.get('created_by').get('handle'))).
                append($("<button type='button'/>").attr({
                    name: 'action',
                    value: 'do'
                }).append(already_member?"Leave Game":"Join Game").click( function() {
                    if (already_member) {
                        game.remove_player({});
                    }
                    else {
                        game.add_player({});
                    }
                    eg.hide();
                    to_game_login('');
                })).
                append($("<button type='button'/>").attr({
                    name: 'action',
                    value: 'ret'
                }).append("Return to game list").click( function() {
                    eg.hide();
                    to_game_login('');
                }));
            eg.show();
        }

	function game_line(game, type) {
            var gameLine = $("<tr/>").
                append($("<td/>").append(game.get('name'))).
                append($("<td/>").append(game.get('number_players'))).
                append($("<td/>").append(game.get('created_by').get('handle')));

            var action = $("<td/>");
            var label;
            var clickEv;
            if (type === 'avail') {
                label = "Examine";
                clickEv = function() {
                    show_game(game, false);
                };
            } else if (type === 'pending') {
                label = "Examine";
                clickEv = function() {
                    show_game(game, true);
                };
            } else if (type === 'active') {
                label = "Play";
                clickEv = function() {
                    alert("Not yet ready.");
                };
            }
            var button = $("<button type='button'/>").attr({
                name: 'action',
                value: label
            }).append(label).appendTo(action);
            button.click( clickEv );
            gameLine.append(action);
            return gameLine;
        }

        function games_table( games, type ) {
            var obj = $("<table/>");
            var header = $("<tr/>").
             append($("<th/>").append("Game")).
             append($("<th/>").append("Number of Players")).
             append($("<th/>").append("Created by"));
            obj.append(header);

            for( var i=0; i<games.length(); ++i ) {
                var game = games.get(i);
                var gameLine = game_line(game, type);
                obj.append(gameLine);
            }
            return obj;
        } //games_table

        function to_game_login(msg) {
            message(msg);
            var active_games  = se_app.fetch_account_root().get('active_games');
            var pending_games = se_app.fetch_account_root().get('pending_games');            
            var avail_games   = se_app.available_games();            
            $('#active_games').empty();
            if( active_games.length() === 0 ) {
                $('#active_games').append( "Not playing any games currently" );
            } else {
                $('#active_games').append( games_table( active_games, 'active' ) );
            }
            $('#pending_games').empty();
            if( pending_games.length() == 0 ) {
                $('#pending_games').append( "Not joined any pending games" );
            } else {
                $('#pending_games').append( games_table( pending_games, 'pending' ) );                
            }
            $('#avail_games').empty();
            if( avail_games.length() == 0 ) {
                $('#avail_games').append( "No available games" );
            } else {
                $('#avail_games').append( games_table( avail_games, 'avail' ) );                
            }

            $('#gamefield').empty();
            $('#gamefield').append('<button type=button id=newgame>New Game</button>');
            
            $('#newgame').click( to_create_game );

            $('#games').show();
        } //to_game_login

        function to_create_game(msg) {
            message(msg);
            $('#gamefield').empty();
            var flavors = se_app.get( 'flavors' );
            $('#gamefield').append(
                '<h2>Create New Game</h2>' + 
                    '<table><tr><th>Name</th><td><input type=text id=game_name></td></tr>' +
                    '<tr><th>Number of Players</th><td><input type=text id=number_players></td></tr>' +
                    '<tr><th>Flavor</th><td id=flavor_td></td></tr>' +
                    '<button type=button id=Create>Create</button>'
            );
            $('#Create').click( function() {
                se_app.create_game( 
                    { //data
                        name:$('#game_name').val(),
                        number_players:$('#number_players').val()
                    },
                    function(d) { //passhandler
                        to_game_login( d.msg );
                    },
                    function(err) { //failhandler
                        to_create_game(err);
                    }
                );
            } );
        } //to_create_game

	    $.yote.util.make_login_box( { 
	        target:'#login_div',
            on_login:to_game_login,
            on_register:to_game_login,
            on_logout:function(){$('#games').hide();}
	    });
	    
	});
    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
#login_div { border: 1px solid black;padding:5px; margin: 5px;}
    </style>
  </head>
  <body>
    <h1>Stellar Expanse</h1>
    <div id=login_div></div>
    <hr>
    <div id=msg></div>
    <div id=games style=display:none>
      <div id=active_games></div>
      <div id=pending_games></div>
      <div id=avail_games></div>
      <div id=gamefield></div>
    </div>
    <div id=examine_game style=display:none></div>
  </body>
</html>
