<!DOCTYPE html>
<html>
  <head>
    <title>Stellar Expanse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/yote/js/jquery-2.1.0.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/json2.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>

    <script src="/templates/default_templates.js"></script>
    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/main.css" rel="stylesheet" type="text/css" media="all" />

    <SCRIPT>
    $().ready(function(){
	$.yote.debug = false;
	$.yote.include_templates( '/templates/default_templates.html' );
	$.yote.util.register_functions( base_templates );

	var app = $.yote.init( 'StellarExpanse::App' );
	$.yote.util.register_item( 'app', app );

	$.yote.util.refresh_ui();
    } );

    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
      .bordered { border: 1px solid black;padding:5px; margin: 5px;}
      #comm_div { margin:10px;border: 3px solid black;background-color:rgba(200,150,30,.4) }
      #chat_panel { margin:10px;border: 3px solid black;background-color:rgba(150,200,30,.4) }
      #whos_panel { margin:10px;border: 3px solid black;background-color:rgba(150,30,200,.4) }
      #side_panel { float: left; }
      #flavor_editor_panel { background-color:rgba(150,150,100,.4) }
      #game { background-color:#8A9 }
      .not_ready { background-color:#FDD }
      .ready { background-color:#DFD }
    </style>
  </head>

  <script type="text/template" class="yote_template_definition" template_name="MoveOrder">
    <# takes ship as the default #>
    <$ show _.to name $>
    <???
    function( ctx ) {
	var arry = ctx.default_parent;
	var idx = ctx.hash_key_or_index;
	var ord = ctx.default_var;

	if( idx == ( arry.full_size() - 1 ) ) { // last destination
	    return '<$$$ control remove <button type="button">remove</button> $$$><br>';
	}
	return '';
    } ???>
    <?
    function( ctx ) {
	var arry = ctx.default_parent;
	var idx = ctx.hash_key_or_index;
	var ord = ctx.default_var;
	if( idx == ( arry.full_size() - 1 ) ) { // last destination
	    $( ctx.controls.remove ).click( function() {
		arry.remove( idx );
		$.yote.util.refresh_ui();
	    } );
	}
    }
    ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="NewMoveOrder">
    <# takes ship as the default #>
    <???
       function( ctx ) {
	   var map = ctx.getvar( 'map' );
	   var ship = ctx.default_var;
	   var from_sector = ctx.getvar( 'move_to' ) || ctx.getvar( 'show_sector' );
	   var from_links = from_sector.get_links();

	   //only a scout can move if this is not a known location
	   if( 1*map.get( from_sector.id ).get_discovered() == 0 && ship.get_ship_class() != 'Scout' ) {
	       ctx.addvar( 'move_left', 0 );
	       return 'No Move Left';
	   }
	   return ctx.getvar( 'move_left' ) + ' jumps left<br><$$$ control new_destination <select><option value=""> Select Destination </option></select> $$$>';
       }
    ???>

    <? function( ctx ) {
	if( ctx.getvar( 'move_left' )*1 == 0 ) return;

	var map = ctx.getvar( 'map' );
	var ship = ctx.default_var;
	var from_sector = ctx.getvar( 'move_to' ) || ctx.getvar( 'show_sector' );
	var from_links = from_sector.get_links();
	var link_keys = from_links.keys();

	var l_opt = '';
	for( var i=0; i < link_keys.length; i++ ) {
	    var link_sector = from_links.get( link_keys[ i ] );
	    //if here isn't in the chart, can't move anywhere not in the chart
	    if( 1*map.get( from_sector.id ).get_discovered() || ( map.get( link_sector.id ) && 1*map.get( link_sector.id ).get_discovered() ) )
		l_opt += '<option value="' + i + '">' + link_sector.get_name()  + '</option>';
	}

	$( ctx.controls.new_destination ).append( l_opt ).change( function() {
	    ship.new_order( {
		order : 'move',
		turn  : ctx.scratch.current_turn,
		from  : from_sector,
		to    : from_links.get( link_keys[ $( ctx.controls.new_destination ).val() ] )
	    } );
	    $.yote.util.refresh_ui();
	} );
    }
    ?>
  </script>


  <script type="text/template" class="yote_template_definition" template_name="Ship">
    <tr> <td><$ show _ name $></td>
         <td><$ show _ cost $></td>
         <td><$ show _ jumps $></td>
         <td><$ show _ size $></td>
         <td><$ show _ defense $></td>
         <td><$ show _ attack_beams $></td>
         <td>
           <??? function( ctx ) {
	       // a bit more complicated now. go through the ships orders and see if it has any move
	       // left. Tally the move. Only put a new move orders box if there is any move of the ship left.
	       var ship = ctx.default_var;
	       var move_left = 1*ship.get_jumps();
	       if( move_left == 0 ) return 'n/a';

	       var move_orders = ship.get_pending_orders();
	       var last_moved = ctx.getvar( 'show_sector' );
	       for( var i=0; i<move_orders.length(); i++ ) {
		   var mo = move_orders.get( i );
		   if( mo.get_order() == 'move' ) {
		       if( i == 0 ) ctx.addvar( 'original_sector' );
		       move_left--;
		       last_moved = mo.get_to();
		   }
	       }
 	       ctx.addvar( 'move_left', move_left );
 	       ctx.addvar( 'move_to', last_moved );
	       if( ! ctx.scratch.ship_move_left ) ctx.scratch.ship_move_left = {};
	       ctx.addvar( 'move_left', move_left );
	       var map = ctx.getvar( 'map' );
	       //only scouts can move from an unexplored sector
	       if( move_left > 0 && ( ship.get_ship_class() == 'Scout' || map.get( last_moved.id ) ) ) return '<@ MoveOrder _ pending_orders 12 @><$$ NewMoveOrder $$>';
	       return '<@ MoveOrder _ pending_orders 12 @>';
	   }
          ???></td>
    </tr>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Ships">
    <#  --------------------- default var is a ships container ------------------- #>
<??? function(c){console.log( [ "SHIPS", c.default_var ] ); return ''; }???>
    <h3>Ships</h3>
    <table> <tr> <th>Quantity</th> <th>Name</th> <th>Cost</th> <th>Jumps</th> <th>Size</th> <th>Defense</th> <th>Beams</th> <th>Move Orders</th> </tr>
     <@ Ship 10 @>
    </table>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="SectorProd">
    <#  --------------------- default var is sector ------------------- #>
    <???
       function( ctx ) {
	   var ords = ctx.default_var.get_pending_orders();
	   var player = ctx.getvar( 'player' );
	   var unspent_resources = player.get_resources();
	   for( var i=0; i<ords.length(); i++ ) {
	       var o = ords.get( i );
	       unspent_resources -= o.get_quantity() * o.get_ship().get_cost();
	   }
	   ctx.scratch.unspent_resources = unspent_resources;
	   return '';
       }
       ???>
       <$@ BuildOrders _ pending_orders @$>
       <$$ NewProdOrder $$>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="NewProdOrder">
    <# takes sector as the default #>
    <p>
      <$$$ control new_quan <select></select> $$$>
      <$$$ control new_type <select><option value="">-</option></select> $$$>
      <$$$ control new_ord <button type="button">New Order</button> $$$>
    </p>
    <? function( ctx ) {
	/*       set up item select and set up click handler on listener */
	var game   = ctx.getvar( 'game' );
console.log( [ 'GAME', game ] );
	var player = ctx.getvar( 'player' );
	var sector = ctx.getvar( 'show_sector' );
	var avail = game.get_flavor().get_ships();
	var opts = '';

	// ships
	var min_cost = 0;
	for( var i=0; i<avail.length(); i++ ) {
	    var it = avail.get( i );
	    var cost = 1 * it.get_cost();
	    min_cost = min_cost == 0 || min_cost > cost ? min_cost : cost;
	    var max_can_buy = cost > 0 ? Math.floor( ctx.scratch.unspent_resources / cost ) : 0;
	    opts += '<option value="' + i + '" ' + ( max_can_buy > 0 ? '' : 'disabled="disabled"' ) + '>'
		+ it.get_name() + '</option>';
	}
	$( ctx.controls.new_type ).append( opts );

	// quantities
	var max_quan = min_cost ? Math.floor( ctx.scratch.unspent_resources / min_cost ) : 0;
	if( max_quan > 0 ) {
	    var quan_opts = '';
	    for( var j=1; j <= max_quan; j++ ) {
		quan_opts += '<option value="' + j + '">' + j + '</option>';
	    }
	    $( ctx.controls.new_quan ).append( quan_opts );
	} else {
	    $( ctx.controls.new_quan ).append( '<option value="0">0</option>' );
	}

	// quantities change when select changes
	$( ctx.controls.new_type ).change(function() {
	    var idx = $( this ).val();
	    var sel_ship = avail.get( idx );
	    var ship_cost = 1*sel_ship.get_cost();
	    max_quan = ship_cost ? Math.floor( ctx.scratch.unspent_resources / ship_cost ) : 0;
	    var quan_opts = '';
	    for( var j=1; j <= max_quan; j++ ) {
		quan_opts += '<option value="' + j + '">' + j + '</option>';
	    }
	    $( ctx.controls.new_quan ).empty().append( quan_opts );
	} );


	$( ctx.controls.new_ord ).click( function() {
	    var ship_idx = $( ctx.controls.new_type ).val();
	    var ship = avail.get( ship_idx );
	    var ord = sector.new_order( { order : 'build',
					  turn  : ctx.scratch.current_turn,
					  ship  : ship,
					  quantity : $( ctx.controls.new_quan ).val()
					},
					function( msg ) {
					    alert( 'make new ' + ship.get_name() + ' for sector ' + sector.get_name() +
						   ' and turn ' + ctx.scratch.current_turn );
					},
					function( err ) {
					    alert( err );
					}
				      );
            $.yote.util.refresh_ui();
	} );
    } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="BuildOrders">
    <# takes sector as the default #>
Make the entries not the can build items, but the orders
<h3>Build Orders</h3>
    <table> <tr> <th>Quantity</th> <th>Name</th> <th>Cost</th> <th>Jumps</th> <th>Size</th> <th>Defense</th> <th>Beams</th> <th>Delete</th> </tr>
       <@ BuildItem 10 @>
    </table>
       Resources avail : <$ show player resources $>

  </script>

  <script type="text/template" class="yote_template_definition" template_name="BuildItem">
    <tr> <td><$$$ control quan_edit <select></select> $$$></td>
         <td><$ show _.ship name $></td>
         <td><$ show _.ship cost $></td>
         <td><$ show _.ship jumps $></td>
         <td><$ show _.ship size $></td>
         <td><$ show _.ship defense $></td>
         <td><$ show _.ship attack_beams $></td>
         <td><$$$ control del_ord <button type="button">Remove</button>  $$$></td>
    </tr>
    <?
        function( ctx ) {
	    var cur_quan = 1 * ctx.default_var.get_quantity();
	    var ship = ctx.default_var.get_ship();
	    var ship_cost = 1*ship.get_cost();
	    var max_quan = ship_cost ? Math.floor( ctx.scratch.unspent_resources / ship_cost ) : 0;
	    var quan_opts = '';
	    for( var j=1; j <= ( cur_quan + max_quan ); j++ ) {
		quan_opts += '<option value="' + j + '" ' + ( j==cur_quan ? ' selected' : '') + '>' + j + '</option>';
	    }
	    $( ctx.controls.quan_edit ).append( quan_opts );
	    $( ctx.controls.quan_edit ).change( function() {
		ctx.default_var.set_quantity( $( this ).val() );
		$.yote.util.refresh_ui();
	    } );

	    $( ctx.controls.del_ord ).click( function() {
		ctx.default_parent.host_obj.remove_from( { name : ctx.collection_name,
							   items : [ ctx.default_var ] } );
		$.yote.util.refresh_ui();
	    } );
	}
     ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ActiveSector">
    <# Default var is a sector #>
    <h3>Active Sector</h3>
    Detail for <b><$ show _ name $></b><br>
    <P>Production : <$ show _ currprod $> / <$ show _ maxprod $>
       Build Capacity <$ show _ buildcap $> </P>
    Links : <% Link _ links 10 %> <P>
    <$@ Ships _ ships @$>
    <$$ SectorProd $$>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Link">
    <??? function( ctx ) {
	var nm = ctx.default_var.get_name().replace( /^\s*([^\s]+)/, '&$1; ' );
	return '<$$$ control link <A HREF="#">' + nm + '</A>$$$>';
    } ???>
    <? function( ctx ) {
	$( ctx.controls.link ).click(function() {
	    alert( ctx.default_var.get_name() );
	} );
    }
    ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Links">
    <% Link 10 %>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Note">
    <??? function(ctx){console.log( ctx.default_var ); return '' } ???>
    <$ show _ msg $>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="SectorNode">
    <$$$ aliasresult ships function( ctx ) {
	var l2s = ctx.getvar( 'loc2ships' );
	var ships = l2s[ ctx.default_var.id ] || [];
console.log( [ "FINDING", ships ] );
	return $.yote.wrap_native_list( { list : ships,
					  field_key : 'faroff_ships',
					  cache_key : args.template_path,
					  wrap_key : ctx.default_var.id } );
    } $$$>
    <tr>
      <td><$ val _.name $></td>
      <td><$ val _.owner.name $></td>
      <td><$ show _ seen_currprod $>/<$ show _ seen_max_production $></td>
      <td><$ show _.links $></td>
      <td><??? function(ctx) { return ctx.default_var.get( 'notes' ) ? '<@ Note _ notes 10 @>' : 'unexplored'; } ???> </td>
      <td><$@ Ships ships @$></td>
     </tr>
  </script>
    
  <script type="text/template" class="yote_template_definition" template_name="OtherSectors">
    <hr>
    <h3>Destinations</h3>
    Last known data <br>
      <table><tr> <th>Name</th> <th>Owner</th> <th>Build Capacity</th> <th>Links</th> <th>Notes</th> <th>Ships</th> </tr>
        <@ SectorNode 12 @>
      </table>
    <hr>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="MySector">
    <tr>
      <td><$$$ control sec_link <a href="#">$$$><$ val _.name $></a></td>
      <td><$ show _ currprod $>/<$ show _ maxprod $></td>
      <td><$ show _ buildcap $></td>
      <td><$ show _.owner name $></td>
      <td><$% Links _ links %$></td>
     </tr>
    <?
    function( ctx ) {
	$( ctx.controls.sec_link ).click( function() {
	    args.getvar( 'player' ).set( 'cur_sector', ctx.default_var );
	    $.yote.util.refresh_ui();
	} );
    }
     ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="MySectors">
    <hr>
    <h3>Owned Sectors</h3>
    <table><tr> <th>Name</th> <th>Prod</th> <th>Build Capacity</th> <th>Owner</th> <th>Links</th> </tr>
      <@ MySector 12 @>
    </table>
    <hr>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="InGame">
    <#  -------------------DECLARATIONS--------------------------- #>
    <???
    function( args ) {
	var acct = $.yote.fetch_account();
	var player = acct.get( 'current_player' );
	if( ! player ) {
	    player = args.getvar( 'game' ).my_player();
	    args.addvar( 'player', player );
	}
	var ships = player.get_ships();
	var loc2ships = {};
	for( var i=0; i < ships.length(); i++ ) {
	    var ship = ships.get( i );
	    var loc = loc2ships[ ship.get_location().id ];
	    if( ! loc ) {
		loc = [];
		loc2ships[ ship.get_location().id ] = loc;
	    }
	    loc[ loc.length ] = ship;
	}
	args.addvar( 'loc2ships', loc2ships );
	args.addvar( 'map', player.get_starchart().get_map() );
	var cur_sec = player.get( 'cur_sector' );
	if( ! cur_sec ) {
	    cur_sec = player.get_sectors().get(0);
	    player.set( 'cur_sector', cur_sec );
	}
	args.addvar( 'show_sector', cur_sec );
	return '';
    } ???>
    <$$$ aliasresult unowned_nodes function( args ) {
	     var player = args.getvar( 'player' );
	     var sectors = player.get_sectors();
	     var known_sectors = {};
	     for( var i=0; i< sectors.length(); i++ ) {
		 var s = sectors.get( i );
		 known_sectors[ s.id ] = s;
	     }
	     var map = player.get_starchart().get_map(); // sector id --> node
	     var unowned = [];
	     var map_keys = map.keys();

	     for( var i in map_keys ) {
		 var s_id = map_keys[ i ];
		 if( ! known_sectors[ s_id ] ) {
		     unowned[ unowned.length ] = map.get( s_id  );
		 }
             }
	     return $.yote.wrap_native_list( { list : unowned, wrap_key : player.id,cache_key : args.template_path, field_key : 'unowned'  } );
	} $$$>

    <#  -------------------  HTML  --------------------------- #>
    <$$$ control backlink <a href='#'>Back To Lobby</a> $$$><br>
    Player is <$ show player name$><br>
    Game is <$ show game name $><br>
    Resources : <$ show player resources $><br>
    Tech Level : <$ show player tech_level $><br>
    On Turn : <?? function( ctx ) { return ctx.scratch.current_turn; } ??>
    <$$$ control ready_div <label class="not_ready"> $$$>
        Ready for next turn <$$$ control ready_check <input class="not-ready" type="checkbox"> $$$>
        </label>


    <$@ MySectors player sectors @$>
    <$@ OtherSectors unowned_nodes @$>
    <$$ ActiveSector show_sector  $$>

    <#  -------------------  AFTER RENDER  --------------------------- #>
    <?
       function( ctx ) {
	   $( ctx.controls.ready_check ).click( function() {
	       var is_ready = $( ctx.controls.ready_check ).is( ':checked' );
	       if( is_ready ) {
		   $( ctx.controls.ready_div ).addClass( 'ready' );
		   $( ctx.controls.ready_div ).removeClass( 'not-ready' );
	       } else {
		   $( ctx.controls.ready_div ).addClass( 'not-ready' );
		   $( ctx.controls.ready_div ).removeClass( 'ready' );
	       }
	       ctx.getvar( 'player' ).mark_as_ready( {
		   turn  : ctx.scratch.current_turn,
		   ready : is_ready
	       }, function() {
		   if( is_ready ) $.yote.util.refresh_ui();
	       } );
	   } );

	   $( ctx.controls.backlink ).click( function() {
	       $.yote.fetch_account().set( 'current_game', '' );
	       $.yote.util.refresh_ui();
	   } );
       }
    ?>
  </script>


  <script type="text/template" class="yote_template_definition" template_name="PendingGames">
    <h3>Pending Games</h3>
    <@ PendGames 3 @>
  </script>


  <script type="text/template" class="yote_template_definition" template_name="PendGame">
    <br>
    <b><$ show _ name $></b> : for <$ show _ number_players $> players.
       Start at tech level <$ show _ starting_tech_level $> with <$ show _ starting_resources $> RUs.
    Created by <$ show _.created_by handle $>. <$$$ control leave_game <button type="button">Leave</button> $$$>
    <? function( args ) {
	 $( args.controls.go_game ).click( function() { alert( 'gonna leave ' + args.default_var.get_name() ); } );
       }
    ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="CreateGame">
    <div>
    Create a new game
    <$$$ control newgamename <input type="text" placeholder="game name"> $$$>
    <$$$ control start_players <input type="number" placeholder="number of players"> $$$>
    <$$$ control start_res <input type="number" placeholder="starting resources"> $$$>
    <$$$ control start_tech <input type="number" placeholder="starting tech level"> $$$>
    <$$$ control newgamego <button type="button">Create</button> $$$>
    </div>
    <? function( args ) {
        $.yote.util.button_actions( {
	    button : args.controls.newgamego,
	    texts  : [ args.controls.newgamename, args.controls.start_players, args.controls.start_res ],
	    action : function() {
		var game = args.default_var.create_game( {
		    name : $( args.controls.newgamename ).val(),
		    number_players : $( args.controls.start_players ).val(),
		    starting_resources : $( args.controls.start_res ).val(),
		    starting_tech_level : $( args.controls.start_tech ).val(),
		    flavor : args.default_var.get_flavors().get(0)
		});
		$.yote.util.refresh_ui();
            }
        } );
    } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ActGame">
    <br>
    <b><$ show _ name $></b> : for <$ show _ number_players $> players.
       Start at tech level <$ show _ starting_tech_level $> with <$ show _ starting_resources $> RUs.
    Created by <$ show _.created_by handle $>. <$$$ control go_game <button type="button">Play</button> $$$>
      <$$$ control del_game <button type="button">Delete Game</button> $$$>
    <? function( args ) {
	 $( args.controls.go_game ).click( function() {
	     var acct = $.yote.fetch_account();
	     if( ! acct.get_current_game() || acct.get_current_game().id != args.default_var.id ) {
		 acct.set( 'current_game', args.default_var );
		 acct.set( 'current_player', args.default_var.my_player() );
	     }
	     $.yote.util.refresh_ui();
	 } );
	 $( args.controls.del_game ).click( function() {
	     if( confirm( 'Really delete game ' + args.default_var.get_name() + '?' ) ) {
		 $.yote.util.refresh_ui();
	     }
	 } );
       }
    ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="AvailGame">
    <br>
    <b><$ show _ name $></b> : for <$ show _ number_players $> players.
       Start at tech level <$ show _ starting_tech_level $> with <$ show _ starting_resources $> RUs.
    Created by <$ show _.created_by handle $>. <$$$ control join_game <button type="button">Join</button> $$$>
    <? function( args ) {
	 $( args.controls.join_game ).click( function() { alert( args.default_var.add_player() ); $.yote.util.refresh_ui(); } );
       }
    ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="AvailableGames">
    <div>
     <h3>Available Games</h3>
     <@ AvailGame 3 @>
    </div>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ActiveGames">
    <h3>Active Games</h3>
    <@ ActGame 3 @>
    <$$ Paginator $$>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Lobby">
    Logged In
    <$@ ActiveGames _acct_ active_games   @$>
    <$@ AvailableGames _ available_games  @$>
    <$@ PendingGames _acct_ pending_games @$>
    <$$ CreateGame $$>
  </script>


  <script type="text/template" class="yote_template_definition" template_name="LoggedIn">
    <$$$ alias game _acct_.current_game $$$>
    <?? function(args) {
	var cur_game = args.getvar( 'game');
	if( cur_game )
	    args.scratch.current_turn = 1*cur_game.get_turn_number();
	if( args.scratch.current_turn == 0 ) {
	    args.scratch.user_acknowledged_turn_change = true;
	}
	if( cur_game ) {
	    return '<$$ InGame $$>';
	}
	else {
	    return '<$$ Lobby $$>';
	}
    }
	    ??>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Splash">
    Join the incredible Stellar Expanse and w00t things.
  </script>

  <script type="text/template" class="yote_template_definition" template_name="MainBody">
    <?? function() { return $.yote.is_logged_in() ? '<$$ LoggedIn $$>' : '<$$ Splash $$>'; } ??>
  </script>


  <BODY>
    <DIV class="yote_template" template="YoteHeader"></div>

    <DIV class="yote_template" template="MainBody" default_variable="app"></div>
  </BODY>

</html>
