<!DOCTYPE html>
<html>
  <head>
    <title>Stellar Expanse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/yote/js/jquery-latest.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/json2.js"></script>

    <script src="/js/main.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>

    <script src="js/game.js"></script>
    <script src="js/lobby.js"></script>
    <script src="js/graph.js"></script>
    <script src="/js/raphael-min.js"></script>

    <link href="/css/main.css" rel="stylesheet" type="text/css" media="all" />
    <link href="css/se.css" rel="stylesheet" type="text/css" media="all" />

    <SCRIPT>
      <!--
    <?YOTE_PRECACHE StellarExpanse::App ?>
    var c = {};
    $().ready(function(){
        $.yote.debug = true;
	$.yote.init();

	// a data structure to store apps, and fetch_app looks there
	// before doing the fetch
	se_app = $.yote.fetch_app( 'StellarExpanse::App' );

	$.yote.util.register_items( {
	    chat : se_app.get_messageboard(),
	    app  : se_app
	} );

	attach_login( {
	    attachpoint : '#logged_in_status',
	    message_attachpoint : '#msg_div',
	    app                 : se_app,
	    after_login         : function() { refresh( true ) },
	    after_logout        : function() { refresh( false ) }
	} );

	function play_game( game ) {
	    var player = game.my_player();
	    player.load_data();
	    current_game = game;
	    current_turn = game.get_turn_number();

	    $( '#lobby' ).hide();
	    $( '#flavor_editor_panel' ).hide();
	    $( '#game_panel' ).attr( 'disabled', 'false' );

	    $.yote.util.register_item( 'game', game );
	    $.yote.util.register_item( 'player', player );
	    c['game'] = game;
	    c['player'] = player;
	    //sectors


	    $( '#game' ).show();
	    if( my_acct.get( 'showing_sector' ) )
		show_sector( my_acct.get_showing_sector() );
	    $.yote.util.refresh_ui();
	    my_acct.set( 'in_game', game );
	} //play_game

	function refresh( logged_in ) {
	    $( '#comm_div' ).empty();

	    if( $.yote.is_root() ) {
		$( 'flavor_editor_panel' ).show();
		$.yote.util.register_items( {
		    flavor_ed : [
			'~<h2>Flavor Name</h2><DIV class="yote_panel" item="$$$" field="name"></DIV>', // flavor name
			'~<H2>Ships</H2><div id="flav_$$" item="$$$" class="control_table" plimit="10" ' +
			    ' container_name="ships" new_object_type="root" ' +
			    ' paginate_override="true" ' +
			    ' columns="' + "['*name','*ship_class','*tech_level','*damage_control','*jumps','*cost','*targets','*self_destruct','*attack_beams','*defense','*size','*racksize','*type']" + '" ' +
			    ' column_headers="' + "['Name','Class','Tech Req','Damage Control','Jumps','Cost','Targets','Self Destruct','Attack Beams','Defense','Size','Racksize','Type']" + '" ' +
			    ' new_columns="' + "['name','ship_class','tech_level','damage_control','jumps','cost','targets','self_destruct','attack_beams','defense','size','racksize','type']" + '" ' +
			    ' new_column_placeholders="' + "['Name','Class','Tech','Damage Control','Jump Range','Cost','Targets','Self Destruct','Attack Beams','Defense','Size','Rack Size','Type']" + '"' +
			    ' new_button="Add Ship" new_attachpoint="#flav_newship_$$" ' +
			    ' new_columns="[' + "'name','ship_class'" + ']" new_column_placeholders="[' + "'name','ship class'" + ']" ' + 
			    '></DIV><DIV id="flav_newship_$$"></DIV>',
			'~<h2>Universe Configuration</h2><div class="yote_panel" item="$$$" field="universe_config"/>',
			'*empire_config',
			'*game_config',
			'*base_config',
			'~<h2>Sector Names</h2>One name to a line. May contain spaces.<br><DIV class="yote_panel" item="$$$" field="sector_names"></div>',
		    ]
		} );
	    } else {
		$( '#flavor_editor_panel' ).hide();
	    }

	    if( logged_in ) {
		my_acct = $.yote.fetch_account();
		$.yote.util.register_items( {
		    active_columns : ['name',
				      function(item,is_prep){ if(is_prep){ return item.current_players().to_list().map(function(it){it.get_name()}).join(',');} },
				      function(item,is_prep){ if(is_prep){ return item.get_needs_players() } },
				      function(item,is_prep){ if(is_prep)return item.get_created_by().get_handle();},
				      'turn_number',
				      function(item,is_prep){if(is_prep){return '<button type="BUTTON" id="play_' + item.id + '">Play</button>'}
							     else{
								 $( '#play_' + item.id ).click(function() {
								     play_game( item );
								 } );
							     }
							    }
				     ],
		    pending_columns : ['name',
				       function(item,is_prep){ if(is_prep){ return item.current_players().to_list().map(function(it){it.get_name()}).join(',');} },
				       function(item,is_prep){ if(is_prep){ return item.get_needs_players() } },
				       function(item,is_prep){ if(is_prep)return item.get_created_by().get_handle();},
				       function(item,is_prep){if(is_prep){return '<button type="BUTTON" id="leave_' + item.id + '">Leave</button>'}
							      else{
								  $( '#leave_' + item.id ).click(function() {
								      item.remove_player();
								      item.sync_changed();
								      $.yote.util.refresh_ui();
								  } );
							      }
							     }
				      ],
		    avail_columns : ['name',
				     function(item,is_prep){ if(is_prep){ return item.current_players().to_list().map(function(it){it.get_name()}).join(',');} },
				     function(item,is_prep){ if(is_prep){ return item.get_needs_players() } },
				     function(item,is_prep){ if(is_prep)return item.get_created_by().get_handle();},
				     function(item,is_prep){if(is_prep){return '<button type="BUTTON" id="join_' + item.id + '">Join</button>'}
							    else{
								$( '#join_' + item.id ).click(function() {
								    item.add_player();
								    item.sync_changed();
								    $.yote.util.refresh_ui();
								} );
							    }
							   }
				    ],
		    acct : my_acct,
		    ship_rows : [
			'name',
			'~<DIV class="control_table" item="$$$" container_name="pending_orders" paginate_override="true" '+
			    ' columns="[]" ' + 
			    ' new_columns="[]" ' +
			    ' new_column_headres="[] ' + 
			    ' new_button="Add order" new_attachpoint="#ship_order_$$" ' +
			    '></DIV>'
		    ],
		} );

		//check to see if in lobby or a game
		if( my_acct.get( 'in_game' ) ) {
		    play_game( my_acct.get_in_game() );
		}
		else {

		    $( '#user_games_panel' ).show();
		    se_app.sync_lobby( my_acct );
		}
		$( '#comm_div' ).append( '<h3>Comm</h3><input type="text" placeholder="connect to" id="connector"> <button id="c_go">connect</button><div id="comm_msg"></div><hr>' );
		$.yote.util.button_actions( {
		    button : '#c_go',
		    texts  : [ '#connector' ],
		    action : function() {
			$( '#comm_msg' ).empty();
			try {
			    convo( $('#connector').val() );
			} catch(err) {
			    $( '#comm_msg' ).append( $('#connector').val() + ' not found' );
			}
		    }
		} );
		var my_comm = my_acct.get_comm();
		var items = my_comm.paginate( { 
		    name : '_convos_with',
		    return_hash : true,
		    sort_fields : [ 'with_name' ],
		    limit : 100
		} );
     
		var ihash = items.to_hash();
		for( var i in ihash ) {
		    var conv = ihash[ i ];
		    if( my_acct.get( 'closed_' + conv.id ) != 'true' )
			convo( i );
		}
	    } //if logged in
	    else {
		$( '#user_games_panel' ).hide();
	    }
	    $.yote.util.refresh_ui();
	} //refresh
	$( '#back_to_lobby' ).click(function() {
	    my_acct.set( 'in_game', '' );
	    $( '#game' ).hide();
	    $( '#game_panel' ).attr( 'disabled', 'true' );
	    $( '#lobby' ).show();
	    $( '#user_games_panel' ).show();
	    $.yote.util.refresh_ui();
	} );
	$.yote.util.init_ui();
    });
     function convo( target_handle ) {
	 var conv = my_acct.get_comm().open_channel( target_handle );
	 var cid     = conv.id;
	 if( typeof $( '#conv_panel_wrapper_' + cid ).val() == 'undefined' ) {
	     $( '#comm_div' ).append( '<DIV id="conv_panel_wrapper_' + cid + '"></div>' );
	 } else {
	     $( '#conv_panel_wrapper_' + cid ).empty();
	 }
	 // create a conversation and attach to the two recipients
 	 my_acct.set( 'closed_' + conv.id, 'false' );
         // create a panel for the conversatoin on the UI
         var ri_hash = { app : se_app };
         ri_hash['conv_' + cid] = conv;
         $.yote.util.register_items( ri_hash );
         var buf = '<DIV id="conv_panel_' + cid + '">\
                    <button type="Button" id="close_' + cid + '">X</BUTTON>\
                    Conversation with ' + target_handle + '<BR>\
                    <div id="conv_msg_' + cid + '"></div>\
                    <div class="control_table" item="$conv_' + cid + '" plimit="15"\
                         container_name="conversations" container_type="hash" show_count="false"\
                         columns="[function(item,is_prep){if(is_prep){return item.get(\'message\')+' +
                                          "'['+item.get_creator().get_handle()+'] ('+new Date(1000*item.get_created_on()).toLocaleString()+')'}}]" + '"\
                         new_button="say" new_attachpoint="#conv_msg_' + cid + '"\
                         paginate_order="reverse" new_columns="[' + "'message'" + ']"\
                         new_column_placeholders="[' + "'message'" + ']"\
                         after_new_function="*function(item){item.set(' + "'created_on',Math.round(new Date().getTime()/1000));item.set('creator',my_acct);" + '\
		         this.item.add_to( { name : ' + "'converstaions'" + ', items : [ item ] } ) }"\
                    >\
                    </DIV>';
         $( '#conv_panel_wrapper_' + cid ).append( buf );
         $( '#close_' + cid ).click( (function(c) { return function() { 
	     $( '#conv_panel_wrapper_' + cid ).remove();
	     my_acct.set( 'closed_' + c.id, 'true' );
	 } } )( conv ) );
	 $.yote.util.init_ui();
     } //convo
     function show_sector( sector ) {
	 $( '#sector_view' ).show();
	 
	 $.yote.util.register_item( 'sector', sector );
	 c[ 'sector' ] = sector;
	 $.yote.util.refresh_ui( '#sector_view .yote_panel,#sector_view .control_table' );
	 my_acct.set( 'showing_sector', sector );
     }

		    -->
    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
      .bordered { border: 1px solid black;padding:5px; margin: 5px;}
      #comm_div { margin:10px;border: 3px solid black;background-color:rgba(200,150,30,.4) }
      #chat_panel { margin:10px;border: 3px solid black;background-color:rgba(150,200,30,.4) }
      #whos_panel { margin:10px;border: 3px solid black;background-color:rgba(150,30,200,.4) }
      #side_panel { float: left; }
      #flavor_editor_panel { background-color:rgba(150,150,100,.4) }
      #game { background-color:#8A9 }
    </style>
  </head>

  <BODY>
    <DIV class="header" id="top_header">
      <img class="left" src="se.png">
      <SPAN id="header_bar"></SPAN>
      <UL id="top_nav" class="nav"></UL>
      <DIV class="login logged_in" id="logged_in_status"></DIV>
      <DIV id="msg_div"></DIV>
    </DIV>

    <DIV id="side_panel">
      <DIV id="chat_panel">
        <h3>Chat</h3>
        <div id="chat_mgs"></div>
        <DIV class="control_table" item="$chat" plimit="15" paginate_overridea="true"
             container_name="chatter" show_count="false" include_remove="*$.yote.is_root()"
             columns="[function(item,is_prep){
                      var cr=item.get_creator();
                      if(is_prep){
                      return item.get('message')+'[<a href=# id=chat_with_' + cr.id + '>'+cr.get_handle()+'</a>] ('+
                      new Date(1000*item.get_created_on()).toLocaleString()+')'
                      }else{
                      $('#chat_with_'+cr.id ).click(function(){convo(cr.get_handle())});
                      }}]"
             after_new_function="*function(item){
                                 item.set('created_on',Math.round(new Date().getTime()/1000));
                                 item.set('creator',my_acct);
                                 }"
             new_button="say" new_attachpoint="#chat_mgs"
             paginate_order="reverse"
             new_columns="['message']"
             new_column_placeholders="['message']"
             ></div>
      </DIV>

      <DIV id="comm_div">
	<!-- Panel for talking directly to an other. Only when logged in with account 
 	     the conversation is between two accounts, so
	     account A -> comm -> {converstaions} :  account B id -> conversation_obj_AB
	     account B -> comm -> {converstaions} :  account A id -> conversation_obj_AB
	     this is for conversations with only two participants. 
	     There could be more, but would have a different container type.
	     This will be populated with all conversations that have not been closed.
	  -->
      </div>
      <DIV id="whos_panel">
	<h3>Who is logged in</h3>
	<DIV class="control_table" paginate_override="true"
	     item="$app" plimit="15" container_name="logged_in" show_count="false"
	     columns="[function(acct,is_prep){if(is_prep){return '<a href=# id=chat_with_online_' + acct.id + ' >' + acct.get_handle() + '</a>'; } else { $( '#chat_with_online_' + acct.id ).click((function(a){return function(){convo(a.get_handle());}})(acct))}}]"
	     >
	</div>
      </div>

      
    </DIV> <!-- side_panel -->
    <DIV id="lobby">

      <DIV id="main_div" class="main_div">
	<h1>Stellar Expanse</h1>

	<!-- Control table for games -->
	<DIV id="games_panel" >
          <div id="user_games_panel">
            <h3>Active Games</h3>
            <DIV class="control_table" paginate_override="true" plimit="10"
		 item="$acct" container_name="active_games"
		 column_headers="['Game','Number of Players', 'Open Slots','Created By','On Turn','Play']"
		 columns="$active_columns"
		 ></DIV>
	    <HR>
	    <h3>Pending Games</h3>
	    <DIV class="control_table" paginate_override="true" plimit="10"
		 item="$acct" container_name="pending_games"
		 column_headers="['Game','Joined Players', 'Open Slots', 'Created By','Leave']"
		 columns="$pending_columns"
		 ></DIV>
	  </DIV>
	</DIV>
	<HR>
        <DIV style="background-color:rgba(100,100,100,.8);display:inline-block">
	  <h3>Available Games</h3>
	  <DIV class="control_table" paginate_override="true" plimit="10"
	       column_headers="['Game','Joined Players', 'Open Slots', 'Created By','Join']"
               item="$app" container_name="pending_games"
               columns="$avail_columns"
               new_function="*function(){return null;}"
               after_new_function="*function(dummy,data){var fs = se_app.get_flavors(); if(fs.length() == 1) data['flavor'] = fs.get(0);var game = se_app.create_game(data);}"
               new_button="New Game" new_attachpoint="#new_game_panel"
               new_columns="!function(){ var arry = ['name','number_players','starting_tech_level','starting_resources'];
			    if( se_app.get_flavors().length() > 1 ) arry[arry.length] = {on_create:function(newitem,id){newitem.set('flavor',$('#'+id).val());},field:'flavor',render:function(ctrl_idx){return '<select id=ctrl_idx>' + se_app.get_flavors().to_list().map(function(it){return '<option value='+it.id+'>'+it.get_name()+'</option>'}).join('') + '</select>';}}; return arry;}"
               new_column_placeholders="['Game Name','Number of Players','Starting Tech Level','Starting Resources','Flavor']"
	       
	       >
	  </DIV>
          <DIV id="new_game_panel"></DIV>
	</DIV>
      </DIV>
    </div>

    <DIV id="flavor_editor_panel">
      <h2>Flavor Editor</h2>
      <DIV item="$app" requires_root="true" include_remove="true" class="control_table" plimit="12"
	   paginate_override="true"
           container_name="flavors"
	   columns="$flavor_ed" column_headers="['Name','Ships','Univ Sector Config','Empire Sector Config','Game Sector Config','Base Sector Config','Sector Names']"
           suppress_table="true" 
           new_button="Add Flavor" new_attachpoint="#new_flavor_div" new_object_type="root"
           new_columns="['name']" new_column_placeholders="['Name']"
           new_function="*function(){return se_app.new_flavor();}"
	   >
      </DIV>
      <DIV id="new_flavor_div"></DIV>
    </DIV>
</DIV>

<DIV id="game" style="display:none">
  <h1>Games and stuff</h1>
  <a id="back_to_lobby" href="#">Back to Lobby</a>
  <DIV id="game_panel" disabled="true">
    <DIV id="stats_panel">
      <table>
	<tr><th>Game</th><td><span class="yote_panel" item="$game" field="name" no_edit="true"></span></td></tr>
	<tr><th>On Turn</th><td><span class="yote_panel" item="$game" field="turn_number" no_edit="true"></span></td></tr>
        <tr><th>Resources</th><td><DIV class="yote_panel" item="$player" field="resources" no_edit="true"></td></tr>
        <tr><th>Tech Level</th><td><DIV class="yote_panel" item="$player" field="tech_level" no_edit="true"></td></tr>
        <tr><th>Ready for next turn</th><td><DIV class="yote_panel" item="$player" field="ready" use_checkbox="true" after_edit_function="*function(arg,plyr){plyr.mark_as_ready({ready:arg,turn:current_turn});if(current_turn!=current_game.get_turn_number()){$.yote.util.refresh_ui();current_turn=current_game.get_turn_number();}}"></td></tr>
      </table>
    </DIV>

    <DIV id="sectors" class="control_table"
         item="$player" plimit="15" paginate_override="true" container_name="sectors"
         column_headers="['Sector']" columns="[function(item,is_render){if(is_render){ return '<a href=# id=show_sector_' + item.id + '>' + item.get_name() + '</a>';}else{$('#show_sector_'+item.id).click(function(){show_sector(item);});}}]"
    >
    </DIV>

    <DIV id="sector_view" style="display:none">
      Sector name : <span class="yote_panel" show="c['sector'].get_name()"></span><br>
      Owner : <span class="yote_panel" show="c['sector'].get_owner().get_name();"></span><br>
      Production : <span class="yote_panel" show="c['sector'].get_currprod()"></span> / <span class="yote_panel" show="c['sector'].get_maxprod()"></span><br>
      <DIV class="control_table" id="sector_orders" item="$sector" container_name="pending_orders" include_remove="true" plimit="20"
           columns="[$.yote.util.select_obj_edit('ship',c['game'].get_flavor().get_ships(),'name'),'*quantity']" column_headers="['building','quantity']"
           new_attachpoint="#new_build_order" new_function="*function(){return c['sector'].new_order({order:'build',turn:current_turn}); }"
           new_column_headers="['quantity','build item']" new_addto_function="*function(){}" remove_function="*function(it,idx){c['sector'].remove_order(it);}"
           new_columns="['quantity',{field:'build_item',on_create:function(newit,id){newit.set('ship',$.yote.get_by_id($('#'+id).val()))},render:function(id){return $.yote.util.build_select_text({id:id,items:c['game'].get_flavor().get_ships(),val:function(it,idx){return it.id;},text:function(it){return it.get_name()}})}}]"
      ></DIV>
      <DIV id="new_build_order"></DIV>
      <DIV class="control_table" id="sector_ship" item="$sector" container_name="ships" plimit="20"
           columns="['name',]" column_headers="['ship name','Orders']"
      ></DIV>
    </DIV>
  </DIV>
</DIV>

</BODY>
</html>
