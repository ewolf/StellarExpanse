<html>
  <head>
    <title>Stellar Expanse</title>

    <script src="/yote/js/jquery-latest.js"></script>
    <script src="/yote/js/jquery.dumper.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/json2.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>
    <script src="/yote/js/yote.system.util.js"></script>
    <link href="/css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/bootstrap-responsive.css" rel="stylesheet" type="text/css" media="all" />
    <link rel="stylesheet" href="/yote/css/jquery.mobile.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/yote/css/ui-lightness/jquery-ui-1.8.23.custom.css" type="text/css" media="all" />
    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />

    <script>
    $().ready(function(){
        $.yote.debug = true;
	$.yote.init();

$("body").bind("DOMSubtreeModified", function() {
    //yes this works
});
        var se_app = $.yote.fetch_app( 'StellarExpanse::App' );
	//se_app.RESET();

	function msg( m, cls ) {
	    $( '#msg_div' ).empty().append( '<div class="' + cls + '">' + m + '</div>' );
	}

	function play_game( game, acct ) {
	    /* sections :
	          news
		  game information/turn information
		  systems panel
		     detail of a system in systems panel ( indicate presence of  foe or our ships  )
		        'subway map' of systems within reach of this one
			'build controls'
		  exploration panel
		      list of sectors not controlled but with our ships there
		  ships panel
		     table of ours ships, showing sector, orders, etc
		  order summary
	     */
	    if( acct.get_Last_played() != game ) {
		acct._send_update( { Last_played : game } );
	    }
	    var game_name  = game.get_name();
	    var on_turn    = game.get_turn_number();
	    var players    = game.current_players();
	    var player     = game.my_player();    // player -> handle
	    var starchart  = player.get_starchart();
	    var map        = starchart.get_map(); //hash of sector id -> star chart node
	    
	    var update_text = '<button class="btn btn-link" type="button" id="back_to_lobby">Back to the Lobby </button><div><dl><dt><h2>' + game_name + '</h2></dt><tt>' +
		'Turn : ' + on_turn  + 
		'<BR><div id="playersdiv">Players : <ul id="playerslist">';

	    var pkeys = players.keys();
	    for( var i=0; i < pkeys.length; i++ ) {
		update_text += '<li>' + pkeys[ i ] + '</li>';
	    }


	    update_text += '</tt></dl></div>';
	    

	    //make a subway map of explored sectors. note if there are unexplored ends, and the connections this sector has.
	    var tab = $.yote.util.make_table( 'border=1' );
	    tab.add_header_row( [ 'Sector' ] );

	    var sectorids = map.keys();
	    console.log( ['stuff',map,starchart] );
	    for( var i=0; i < sectorids.length; i++ ) {
		var node = map.get( sectorids[i] );
		if( node.get_discovered() == '1' ) {
		    tab.add_row( [ node.get_name() ] );
		}
	    }

	    $( '#main_div' ).empty().append( update_text + '<div>' + tab.get_html() + '</div>' );

	    $( '#back_to_lobby' ).click( function() {
		acct._send_update( { Last_played : '' } );
		to_game_login( acct.get_login(), acct, '' );
	    } );

	    // subway map?
	    /*
                   gamma --\
		            \
	           alpha -- beta -- omega -- iota
		              \
			       \-- zeta
	     */

	} // play game

        function to_game_login( login, acct, message ) {
	    if( acct.get( 'Last_played' ) ) {
		play_game( acct.get_Last_played(), acct );
		return;
	    }
            var active_games  = acct.get_active_games();
            var pending_games = acct.get_pending_games();
            var avail_games   = se_app.available_games();
	    msg( message );
	    var update_text = '<dl id="main_dl">'; 

	    if( active_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Number of Players', 'Created By', 'On Turn', 'Play' ] );
		for( var i=0 ; i < active_games.length() ; i ++ ) {
		    var game = active_games.get( i );
		    tab.add_row( [ game.get_name(), game.get_number_players(), game.get_created_by().get_handle(), game.get_turn_number(), '<button type="button" id="play_' + game.id + '" class="btn btn-link">Play</button>' ] );
		}
		update_text += "<dt>Active Games</dt><tt>" + tab.get_html() + "</tt>";
	    } //active games

	    if( pending_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Joined Players', 'Created By', 'Leave' ] );
		for( var i=0 ; i < pending_games.length() ; i ++ ) {
		    var game = pending_games.get( i );
		    tab.add_row( [ game.get_name(), game.active_player_count() + " of " + game.get_number_players(), game.get_created_by().get_handle(), '<button type="button" id="leave_' + game.id + '" class="btn btn-link">Leave Game</button>' ] );
		}
		update_text += "<dt>Games waiting to start</dt><tt>" + tab.get_html() + "</tt>";
		for( var i=0 ; i < pending_games.length() ; i ++ ) {
		    var g = pending_games.get( i );
		    $( '#leave_' + g.id ).click( (function( game, login, acct ) { return function() {
			game.remove_player('',function(m){ to_game_login( login, acct, m ) },function(e){ msg( e ) });
		    } } )( g, login, acct ) );
		}
	    } //pending games

	    if( avail_games.length() > 0 ) {
		var tab = $.yote.util.make_table('border=1');
		tab.add_header_row( [ 'Game', 'Joined Players', 'Starting Tech', 'Starting Resources', 'Created By', 'Join' ] );
		for( var i=0 ; i < avail_games.length() ; i ++ ) {
		    var game = avail_games.get( i );
		    tab.add_row( [ game.get_name(),
				   game.active_player_count() + " of " + game.get_number_players(),
				   game.get_starting_tech_level(),
				   game.get_starting_resources(),
				   game.get_created_by().get_handle(),
				   '<button type="button" id="join_' + game.id + '" class="btn btn-link">Join Game</button>'
				 ] );
		}
		update_text += "<dt>Available Games</dt><tt>" + tab.get_html() + "</tt>";
	    } //available games

	    update_text += '</dl></div>';

	    $( '#main_div' ).empty().append( update_text + '<button id="newgame" type="button">New Game</button>' );

	    for( var i=0 ; i < avail_games.length() ; i ++ ) {
		var g = avail_games.get( i );
		$( '#join_' + g.id ).click( (function( game, login, acct ) { return function() {
		    game.add_player( '', function(m) { to_game_login( login, acct, m ) },function(e){msg( e ) } );
		} } )( g, login, acct ) );
	    }

	    for( var i=0 ; i < active_games.length() ; i ++ ) {
		var g = active_games.get( i );
		$( '#play_' + g.id ).click( (function( game, acct ) { return function() {
		    play_game( game, acct );
		} } )( g, acct ) );
	    }

	    $( '#newgame' ).click(function() {
		update_text = '<button class="btn btn-link" type="button" id="back_to_lobby">Back to the Lobby </button><h2>Create New Game</h2>';
		var tab = $.yote.util.make_table();
		var flavors = se_app.get_flavors();
		tab.add_param_row( [ 'Name', '<input type="text" id="game_name_fld">' ] );
		if( flavors.length() > 1 ) {
		    var sel_text = '<select id="flavor_sel">';
		    if( flavors.length() > 1 ) {
			for( var i=0; i<flavors.length(); ++i ) {
			    var flav = flavors.get(i);
			    sel_text += '<option value="' + i + '">' + flav.get_name() + '</option>';
			}
		    }
		    tab.add_param_row( [ 'Flavor', sel_text + '</select>' ] );
		} else {
		    var fl = flavors.get(0);
		    tab.add_param_row( [ 'Flavor', '<span>' + fl.get_name() +
					 '</span><input type="hidden" id="flavor_sel" value="0">' ] );

		}
		var player_sel = '<select id="player_sel">';
		for( var i=1; i < 9; i++ ) {
		    player_sel += '<option value="' + i + '">' + i + '</option>';
		}
		tab.add_param_row( [ 'Number of Players', player_sel + '</select>' ] );
		var tect_sel = '<select id="tech_sel">';
		for( var i=1; i < 5; i++ ) {
		    tech_sel = '<option value="' + i + '">' + i + '</option>';
		}
		tab.add_param_row( [ 'Starting Tech Level', tech_sel + '</select>' ] );
		tab.add_param_row( [ 'Starting Resources', '<input type="text" id="resource_fld">' ] );
		update_text += tab.get_html() + '<BR><button type="button" id="create_game" class="btn disabled btn-link">Create</button>';

		$( '#main_div' ).empty().append( update_text );

		$( '#back_to_lobby' ).click( function() {
		    acct._send_update( { Last_played : '' } );
		    to_game_login( acct.get_login(), acct, '' );
		} );

		$( '#game_name_fld,#resource_fld' ).keyup(function() {
		    if( $( '#game_name_fld' ).val() && $( '#resource_fld' ).val() > 0 ) {
			$( '#create_game' ).removeClass( 'disabled' );
		    } else {
			$( '#create_game' ).addClass( 'disabled' );
		    }
		} );
		$( '#create_game' ).click( function() {
		    se_app.create_game(
			{
                            name:$('#game_name_fld').val(),
                            number_players:$('#player_sel').val(),
			    starting_resources:$('#resource_fld').val(),
			    starting_tech_level:$('#tech_sel').val(),
			    flavor:flavors.get($('#flavor_sel').val())
			},
			function( msg ) {
			    to_game_login( login, acct, msg );
			},
			function( err ) {
			    msg( err );
			}
		    );
		} );
	    });


	} //to_game_login

	$.yote.util.make_login_bar( { brand_html         : '<a class="brand"><IMG src="se.png"> <huge>Stellar Expanse</huge></a>',
				      app                : se_app,
				      container_id       : '#nav-container',
				      logged_in_function : function( login, act ) { to_game_login( login, act, "Welcome, " + login.get_handle()) } ,
				      not_logged_in_function : function(){$('#games').hide();},
				      modal_div          : '#modal_div'
				    } );
    });
    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
      .bordered { border: 1px solid black;padding:5px; margin: 5px;}
    </style>
  </head>
  <body>
    <div STYLE="background-color:#181818;vertical-align:middle">
	<div id="nav-container" class="container" style="width: auto"></div>
    </div>

    <HEADER class="jumbotron subhead" style="height:70px">
      &nbsp;
      <div style="position:fixed;top:350px;left:350px;" id="modal_div"></div>
    </HEADER>

    <DIV id="outer_div" style="margin:10px">
      <DIV id="msg_div"></div>
      <DIV id="main_div"></div>
    </DIV>
    <script src="/js/bootstrap.js"></script>
  </body>
</html>
