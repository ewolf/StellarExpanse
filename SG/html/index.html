<!DOCTYPE html>
<html>
  <head>
    <title>Space Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/yote/js"></script>  

    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/main.css" rel="stylesheet" type="text/css" media="all" />

    <SCRIPT>

    $().ready(function(){
        startme();
    } );

    function startme() {
        $.yote.debug = false;
        $.yote.templates.import_templates( '/templates/default_templates.html' );
        
        var app = $.yote.init( 'SG::App' );
        app.precache();
        $.yote.templates.init();
        $.yote.templates.refresh();
        $( '#spinner' ).hide();
    }
    </script>
    <style>
      .emp   { font-family:"Lucida Console",monospace;  }
      .bordered { border: 1px solid black;padding:5px; margin: 5px;}
      #comm_div { margin:10px;border: 3px solid black;background-color:rgba(200,150,30,.4) }
      #chat_panel { margin:10px;border: 3px solid black;background-color:rgba(150,200,30,.4) }
      #whos_panel { margin:10px;border: 3px solid black;background-color:rgba(150,30,200,.4) }
      #side_panel { float: left; }
      #game { background-color:#8A9 }
      .not-ready { background-color:#FDD }
      .ready { background-color:#DFD }
      td.number { text-align: center; }
      td.panel { border : 1px solid black; padding: 3px; }
      .messages { margin : 12px; padding: 5px; border : solid 3px brown; text-align:center; }
      .err { background-color: lightorange; border : 2px red solid; }
      .owned { background-color: lightgreen; border : 2px green solid; }
      .row td { border-top: 1px solid black; }
      .emph { background-color: lightgreen; font-size: larger; font-decoration: bold }

      .gamepicker { border : dotted 2px gold; margin-left: 15px; padding: 4px; }
      .err { background-color: #FAB }
      .bigpanel { 
          background-color: lightblue;
          min-width : 500px;
          min-height : 500px;
          margin : 15px;
          padding : 15px;
          display: inline-block;
      } 
      .sidepanel { 
          background-color: lightblue;
          min-width : 300px;
          min-height : 500px;
          margin : 15px;
          padding : 15px;
          display: inline-block;
          float: right;
      } 
      .innerpanel { 
          background-color: lightgreen;
          margin: 15px;
      }
    </style>
  </head>

  <script type="text/template" class="yote_template_definition" template_name="SystemMap">
        System map goes here
  </script>

  <script type="text/template" class="yote_template_definition" template_name="WorkerSelect">
    <$$$ sel <select> $$$>
    <??? function( ctx ) {
        if( ctx.args.length > 1 ) {
            var obj = ctx.parse( ctx.args[ 0 ] );
            var fld = ctx.args[ 1 ];
            var max = ctx.args[ 2 ] ? 1* ctx.args[2] : 0;
            var avail = ctx.vars.avail_workers;
            var already_working = 1*obj.get( fld );
            var buf = '';
            for( var i=0; i <= already_working + avail && ( max == 0 || max >= i); i++ ) {
                buf += '<option value="' + i + '"' + ( already_working == i ? ' selected="selected"' : '') + '>' + i + '</option>';
            }
            return buf;
        }
    } ???>
    </select>

    <? function( ctx ) {
        if( ctx.args.length > 1 ) {
            var obj = ctx.parse( ctx.args[ 0 ] );
            var fld = ctx.args[ 1 ];
            $( ctx.controls.sel ).change( function() {
                obj.set( fld, $( this ).val() );
                ctx.refresh();
            } );
        }
      } ?>
    
  </script>

  <script type="text/template" class="yote_template_definition" template_name="field">
    <??? function( ctx ) {
        if( ctx.args.length > 1 ) { 
            
        }
    } ???>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ResourceRow">
    <??? function( ctx ) { 
           var dist = ctx.vars.dist[ ctx.vars._ ];
           ctx.vars.mined    = dist > 0 ? 10 * 1*ctx.vars.mines.get( ctx.vars._ ).get_rate() : '-';
           ctx.vars.untapped = dist > 0 ? 1*ctx.vars.planet.get_abundance() * dist  / 10.0 - 10*ctx.vars.mines.get( ctx.vars._ ).get_rate() : '-';
           ctx.vars.in_depot = dist > 0 ? 10 * 1*ctx.vars.depos.get( ctx.vars._ ).get_contents() : '-';
           ctx.vars.cost     = 10 * 1*ctx.vars.economy.get( ctx.vars._ ).get_current_price();
    } ???>
    <tr> <td><$ _ $></td> 
         <td><$ mined $></td> 
         <td><$ untapped $></td> 
         <td><$ in_depot $></td> 
         <td><$ cost $></td> 
    </tr>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="MyPlanet">
    <??? 
    function( ctx ) { 
        ctx.vars.factory = ctx.vars.planet.get_factory();
        var mines = ctx.vars.planet.get_mines();
        ctx.vars.mines = mines;

        ctx.vars.col = ctx.vars.planet.get_colony();
        ctx.vars.avail_workers = 1*ctx.vars.col.get_population() - 
            ( 1*ctx.vars.col.get_workers_expanding() +
              1*ctx.vars.col.get_commerce_workers() + 
              1*ctx.vars.factory.get_workers_expanding() +
              1*ctx.vars.factory.get_workers_manufacturing() );
        if( mines ) {
            mines = mines.to_hash();
            for( var res in mines ) {
                var mine = mines[ res ];
                ctx.vars.avail_workers -= (
                    1* mine.get_workers_expanding() + 
                        1*mine.get_workers_mining() );
            }
        }
        
        var depos = ctx.vars.planet.get_resource_depos();
        ctx.vars.depos = depos;
        if( depos ) {
            depos = depos.to_hash();
            for( res in depos ) {
                var depot = depos[ res ];
                ctx.vars.avail_workers -= (
                    1 * depot.get_workers_expanding()
                );
            }
        }
    } ???>

    <div class="innerpanel">
      <h3>Showing planet <$ planet.name $></h3>
      population : <$ planet.colony.population $>
        <br>
        <br>
        mineral wealth : <$ planet.abundance $> units per turn
        <br>
        <br>
          <table> <tr> <th>resource</th> <th>mined</th> <th>untapped</th> <th>in depot</th> <th>cost</th> </tr>
            <@ ResourceRow @resources 15 @>
          </table>
          <br>
          factory output : <$ planet.factory.build_rate $> units per turn
    </div>

    <div class="innerpanel">
      <table> <tr> <th>Workers</th> <th>Task</th> </tr>
      <?? function( ctx ) { return 1*ctx.vars.col.get_population() < 1*ctx.vars.planet.get_max_pop() ? 
                                '<tr> <td> <$$ WorkerSelect col commerce_workers $$> </td> ' + 
                                   '<td> Make Money    </td> </tr>' + 
                                '<tr> <td> <$$ WorkerSelect col workers_expanding $$> </td> ' + 
                                   '<td> Expand Colony    </td> </tr>' : ''; } ??>
      <?? function( ctx ) { 
        var dist = ctx.vars.planet.get( 'resource_distribution' );
        var mines = ctx.vars.mines;
        var buf = '';
        if( dist && mines ) {
            mines = mines.to_hash();
            var depot = ctx.vars.depos.to_hash();
            var resses = dist.keys();
            resses.sort();
            dist = dist.to_hash();
            ctx.vars.dist = dist;
            for( var i in resses ) {
                var res = resses[ i ];
                var rate = mines[ res ] ? 1*mines[ res ].get_rate() : 0;
                if( rate < 1*ctx.vars.planet.get_abundance() )
                    buf += '<tr><td> <$$ WorkerSelect mines.' + res + ' workers_expanding $$> </td><td> ' + ( rate > 0 ? 'Expand' : 'Build' ) + ' ' + res + ' mine </td></tr>';

                var cap = depot[ res ] ? 1*depot[ res ].get_capacity() : 0;
                buf += '<tr><td> <$$ WorkerSelect depos.' + res + ' workers_expanding $$> </td><td> ' + ( cap > 0 ? 'Expand' : 'Build' ) + ' ' + res + ' depot </td></tr>';
                        
                if( rate > 0 )
                    buf += '<tr><td> <$$ WorkerSelect mines.' + res + ' workers_mining ' + rate + ' $$> </td><td> mining ' + res + '</td></tr>';
            }
        }
        return buf;
       } ??>

      <tr> <td> <$$ WorkerSelect factory workers_expanding $$> </td> 
           <td> <?? function( ctx ) { return ctx.vars.factory.get_build_rate() > 0 ? "Develop" : "Build"; } ??> Factory </td> 
      </tr>
           <?? function( ctx ) { return 1*ctx.vars.factory.get_build_rate() > 0 ? 
                                 '<tr> <td> <$$ WorkerSelect factory workers_manufacturing ' + (ctx.vars.factory.get_build_rate()/10) + ' $$> </td> <td> Manufacturing   </td> </tr>' : ''; } ??>
     </table>
    </div>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="OtherPlanet">
    Other
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Recipe">
    <??? function(ctx) { 
        var r = ctx.scratch.view_recipe; 
        ctx.vars.view_recipe = r;
        if( r ) {
            r.set( 'is_calculated', '0' );
            ctx.vars.game.calculate_recipe_stats( r );
            ctx.vars.components = ctx.vars.game.get( 'component_size' ).keys();
            ctx.vars.stats = r.get_stats().keys().sort();
        }
        ctx.vars.selist = [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ];
    } ???>
    Recipe for <$ view_recipe.name $>
    <div>
    <@ ComponentRow @components 10 @>
    </div>
    Stats for  <$ view_recipe.name $>
    <div>
    <@ StatRow @stats 10 @>
    </div>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="StatRow">
    <br><$ _ $> : <?? function( ctx ) { 
        var val = 1 * ctx.vars.view_recipe.get( 'stats' ).get( ctx.vars._ ) || 0;
        return ctx.vars._ == 'jump_rating' ? 
            val >= 1 ? '<span class="green">can jump</span>' : '<span class="red">cannot jump</span>'
            : val; 
    }  ??>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ComponentRow">
    <br><$$ edit_hash_with_select_scalars selist view_recipe components _  $$><$ _ $> 
  </script>

  <script type="text/template" class="yote_template_definition" template_name="RecipeRow">
    <li>
         <$ _.name $>
        <$$$ toedit <a href="#">$$$>edit</a>
        <$$$ tobuild <a href="#">$$$>queue up to build</a>
      </li>
    <? function( ctx ) {
        $( ctx.controls.toedit ).click( function() {
            ctx.scratch.view_recipe = ctx.vars._;
            ctx.scratch.view = 'Recipe';
            ctx.refresh();
        } );
        $( ctx.controls.tobuild ).click( function() {
            ctx.vars.game.queue_build( { factory : ctx.vars.factory, recipe : ctx.vars._ } );
        } );
    } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Recipes">
    <h3>Ship Designs</h3>
    <ul>
     <@ RecipeRow player@recipes 10 @> <$$ Paginator player@recipes $$>
    </ul>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="InGame">
    <??? function( ctx ) {
        ctx.vars.game = ctx._acct_.get_current_game();
        var player = ctx.vars.game.player();
        ctx.vars.player = player;
        var eco = player.get_economy();
        ctx.vars.economy = eco;
        
        // resources in ascending price order
        var resources = ctx.vars.economy.keys();
        resources.sort( function( a, b ) {
            return a == 'ore' ? -1 : b == 'ore' ? 1 : a.localeCompare( b );
        } );

        var resources_by_cost = ctx.vars.economy.keys().sort();
        resources_by_cost.sort( function( a, b ) {
            return a == 'ore' ? -1 : eco.get( a ).get_current_price() - eco.get( b ).get_current_price();
        } );
        ctx.vars.resources = resources;

        ctx.vars.systems = player.get_systems();
        ctx.vars.system = ctx.vars.systems.get( 0 );
        var lastp = player.get( 'last_planet' );
        if( lastp ) {
            ctx.vars.planet = lastp;
        } else {
            lastp = ctx.vars.system.get_planets().get(0);
            player.set( 'last_planet', lastp );
            ctx.vars.planet = lastp;
        }
        
        ctx.vars.colony = ctx.vars.planet.get( 'colony' );
        if( ! ctx.scratch.view ) {
            ctx.scratch.view = 'SystemMap';
        }
    } ???>
    <$$$ lob <a href="#">Back to lobby</a> $$$>
    
    <h3>Playing <b><$ game.name $></b> game</h3>

    <div>
      <$$$ bigpanel <div class="bigpanel"> $$$>
        <?? function( ctx ) { return '<$$ ' + ctx.scratch.view + ' $$>'; } ??>
      </div>

      <div class="sidepanel">

        <?? function( ctx ) { return ctx.vars.colony && ctx.vars.player.is( ctx.vars.colony.get_owner() ) ? '<$$ MyPlanet $$>' : '<$$ OtherPlanet $$>'; } ??>

        <div class="innerpanel">
          <$$ Recipes $$>
        </div>

        <div class="innerpanel">
           Factory Production
        </div>

        <div class="innerpanel">
           <$$$ turn_ready <button type="button">$$$>Ready for next turn</button>
        </div>

      </div>
    </div>
    
    <? function( ctx ) {
          $( ctx.controls.lob ).click( function() {
              ctx._acct_.set( 'current_game', '' );
              ctx.refresh();
          } );
        $( ctx.controls.turn_ready ).click( function() {
            ctx.vars.game.ready_player( ctx.vars.player );
            ctx.refresh();
        } );
       } ?>
  </script>

  <! ---------------------------- LOBBY ----------------------------->

  <script type="text/template" class="yote_template_definition" template_name="PendGame">
    <br>
    <b><$  _.name $></b> : Created by <$  _.created_by.handle $>. 
      <??? function( ctx ) { 
            if( ctx._acct_.is( ctx.vars._.get( 'created_by' ) ) ) 
                return '<$$$ remove_game <button type="button">Delete</button> $$$>';
        } ???>
    <? function( ctx ) {
          var leave_idx = ctx.hashkey_or_index;
          $( ctx.controls.remove_game ).click( function() { 
              ctx._app_.remove_game( ctx.vars._ );
              ctx.refresh();
          } );
    }
    ?>
    <# PendGame #>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="CreateGame">
    <div>
    Create a new game
    <$$$ newgamename <input type="text" placeholder="game name"> $$$>
    <$$$ newgamego <button type="button">Create</button> $$$>
    </div>
    <? function( ctx ) {
        $.yote.util.button_actions( {
            button : ctx.controls.newgamego,
            texts  : [ ctx.controls.newgamename ],
            action : function() {
                var game = ctx._app_.create_game( {
                    name : $( ctx.controls.newgamename ).val(),
                    number_players : 1
                });
                ctx.refresh();
            }
        } );
    } ?>
    <# CreateGame #>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="ActGame">
    <br>
    <b><$  _.name $></b> : for <$  _.number_players $> players.
    Created by <$  _.created_by.handle $>. <$$$ go_game <button type="button">Play</button> $$$>
      <$$$ del_game <button type="button">Delete Game</button> $$$>
    <? function( ctx ) {
     $( ctx.controls.go_game ).click( function() {
         var acct = $.yote.fetch_account();
         acct.set( 'current_game', ctx.vars._ );
         ctx.refresh();
     } );
     $( ctx.controls.del_game ).click( function() {
         var key = ctx.hashkey_or_index;
         if( confirm( 'Really delete running game ' + ctx.vars._.get_name() + '?' ) ) {
             ctx._app_.remove_game( ctx.vars._ );
             ctx.refresh();
         }
     } );
       }
    ?>
    <# ActGame #>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="AvailGame">
    <br>
    <b><$  _.name $></b> : 
    Created by <$  _.created_by.handle $>. <$$$ join_game <button type="button">Join</button> $$$>
    <??? function( ctx ) {
        if( ctx._acct_.is( ctx.vars._.get( 'created_by' ) ) ) {
            return '<$$$ remove_game <button type="button">Delete</button> $$$>';
        }
    } ???>

    <? function( ctx ) {
          $( ctx.controls.remove_game ).click( function() { 
              ctx._app_.remove_game( ctx.vars._ );
              ctx.refresh();
          } );

         $( ctx.controls.join_game ).click( function() { 
             $.yote.debug = true;
             ctx.vars._app_.add_player(ctx.vars._,
                                       function(msg){
                                           ctx.scratch.avail_message = "Joined game '" + ctx.vars._.get_name() + "'";
                                       },
                                       function(err){
                                           ctx.scratch.avail_err_message = err;
                                       });
             if( ctx.vars._.get( 'is_active' ) ) {
                 ctx._acct_.set( 'active_game', ctx.vars._ );
             }
             $.yote.debug = false;
             ctx.refresh(); 
          } );
       } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Lobby">
    <??? function( ctx ) {
        // find games you can join, games you have joined that are pending starting, and active games you are in

        var ag = [];
        var myg = ctx._acct_.get( 'joined_games' ) ? ctx._acct_.get( 'joined_games' ).to_hash() : {};
        var appg = ctx._app_.get( 'available_games' ) || [];

        // games you can join, or available games are the joinable games overall - the ones
        //       already joined
        
        // games you can join
        for( var i=0; i<appg.length(); i++ ) {
            var g = appg.get(i);
            if( ! myg[ g.id ] )
                ag.push( g );
        }
        ctx.vars.available_games = ag;

        var actv = [];
        var pend = [];
        for( var gid in myg ) {
            var g = myg[ gid ];
            if( g.get( 'is_active' ) ) 
                actv.push( g );
            else
                pend.push( g );
        }
        ctx.vars.active_games = actv;
        ctx.vars.pending_games = pend;
    } ???>
    <div>
      <div style="display:inline-block">
        Welcome <b> <$ _acct_.handle $> </b>
          <h4>Active Games</h4> 
            <div class="gamepicker">
             <?? function(ctx){ return ctx._acct_.count( 'active_games' ) > 0 ? '' : 'not playing any games';} ??>
             <@ ActGame @active_games 10 @><$$ Paginator @active_games $$>
            </div>
          <???
              function(ctx){ 
                  if( ctx.vars.pending_games.length > 0 )
                      return ' <h4>Pending Games</h4> ' + 
                               '<div class="gamepicker"> ' + 
                               '<$$$ pend_msg <p class="messages" style="display:none"></p> $$$>' +
                               '<@ PendGame @pending_games 10 @><$$ Paginator @pending_games $$>' + 
                               '</div>';
                  } ???>
          <h4>Available Games</h4> 
            <div class="gamepicker">
              <$$$ avail_msg <p class="messages" style="display:none"></p> $$$>

              <?? function(ctx){ return ctx.parse( '@available_games' ).to_list().length > 0 ? '' : 'no games available.';} ??>
              <@ AvailGame @available_games 10 @><$$ Paginator @available_games $$> 
            </div>
          <p>
            <$$ CreateGame $$>
          </p>
      </div>
      <div style="float:right;display:inline-block">
        <$$ Chat $$>
      </div>
    </div>
    <? function( ctx ) {
        if( ctx.scratch.avail_message ) {
            $( ctx.controls.avail_msg ).append( ctx.scratch.avail_message ).show();
            ctx.scratch.avail_message = '';
        }         
        else if( ctx.scratch.avail_err_message ) {
            $( ctx.controls.avail_msg ).append( ctx.scratch.avail_err_message ).addClass( 'err' ).show();
            ctx.scratch.avail_err_message = '';
        }
    } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Chat">
    <div style="border: solid 2px white; background-color: lightblue; max-width: 30em">
      <h4>Global Chat</h4>
      <$$$ chativ <div style="border: groove 2px; background-color: grey; padding:5px; max-height: 100px; overflow: auto"> $$$>
        <$$ Chatter $$>
      </div>
      <$$$ whatsay <input type="text"> $$$> <$$$ say <button type="button">Say</button> $$$>
    </div>
    <? function( ctx ) {
        $( ctx.controls.chativ ).scrollTop($( ctx.controls.chativ ).prop('scrollHeight'));

        $.yote.util.button_actions( {
            button : ctx.controls.say,
            texts : [ ctx.controls.whatsay ],
            action : function() { 
                ctx._app_.chat( $( ctx.controls.whatsay ).val() );
                ctx.refresh();
            }
        } );
       } ?>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Chatter">
    <??? function( ctx ) {
            ctx.vars.chatlog = ctx.parse( '_app_@chatter' );
            ctx.vars.chatlog.sort_reverse = true;
            var l = ctx.parse( 'chatlog' ).to_list();
            var b = [];
            for( var i=0; i<l.length && b.length < 12; i++ ) {
                b.push( '<b>' + l[ i ].get_from() + ':</b> ' + l[i].get_msg() );
            }
            b.reverse();
            return b.join('<br>');
         } ???>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="LoggedIn">
    <?? function(ctx) {
    
        var cur_game = ctx._acct_.get( 'current_game' );
        
        return cur_game ? '<$$ InGame $$>' : '<$$ Lobby $$>';
    } ??>
    <# LoggedIn #>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="Splash">
     Welcome to space game prototype
     <br>
     <$$ Logged_out $$>
  </script>

  <script type="text/template" class="yote_template_definition" template_name="MainBody">
    <??? function( ctx ) { 
            ctx.refresh = function() {
                $( '#spinner' ).show();
                $.yote.templates.refresh();
                $( '#spinner' ).hide();
            }
         } ???>
    <?? function( ctx ) { ctx.scratch.message = ''; return $.yote.is_logged_in() ? '<$$ LoggedIn $$>' : '<$$ Splash $$>'; } ??>
  </script>

  <BODY>
    <img id="spinner" src="spinnerLarge.gif">
    <DIV class="yote_template" template="MainBody"></div>
  </BODY>

</html>
